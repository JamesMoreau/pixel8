<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pixel8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background: #3d597f;
        background-image: url("assets/axiom-pattern.png");
        background-size: auto;
        background-blend-mode: multiply;
        min-height: 100vh;
      }
    </style>
  </head>
  <body class="p-6">
    <h1 class="text-4xl font-bold text-center text-gray-200 mb-1">pixel8</h1>
    <h2 class="text-lg text-gray-300 text-center mb-6">
      Convert any image to pixel art
    </h2>

    <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-6">
      <div class="mb-4 flex items-center justify-between">
        <label for="imageInput" class="text-gray-700">Upload Image:</label>
        <input
          id="imageInput"
          type="file"
          accept="image/png, image/jpeg"
          class="w-2/3 text-sm text-gray-600 border border-gray-300 rounded-md cursor-pointer focus:outline-none"
        />
      </div>

      <!-- Block Size UI -->
      <div class="mb-4 flex items-center justify-between">
        <label for="blockSize" class="text-gray-700"
          >Block Size:
          <span id="blockSizeValue" class="font-semibold ml-1">10</span>
        </label>
        <input
          id="blockSize"
          type="range"
          min="1"
          max="24"
          value="10"
          class="w-2/3 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
          oninput="document.getElementById('blockSizeValue').textContent = this.value"
        />
      </div>

      <!-- Color Palette UI -->
      <div class="mb-4 flex items-center justify-between">
        <label for="palette" class="text-gray-700">Color Palette:</label>
        <select
          id="palette"
          class="w-2/3 text-sm text-gray-600 border border-gray-300 rounded-md focus:outline-none"
          onchange="updatePaletteColors()"
        >
          <option value="none">None (Original Colors)</option>
          <option value="vibrant">Vibrant</option>
          <option value="pastel">Pastel</option>
          <option value="grayscale">Grayscale</option>
          <option value="nes">NES Palette</option>
          <option value="custom">Custom</option>
        </select>
      </div>

      <!-- Container for displaying the colors of the selected palette -->
      <div id="colorDisplay" class="flex space-x-2 mt-4 mb-4"></div>

      <!-- Custom Palette Inputs (hidden by default) -->
      <div id="customPaletteContainer" class="mb-4" style="display: none">
        <p for="customPaletteColors" class="text-gray-700"
          >Custom Colors:</label
        >
        <div id="customPaletteColors" class="flex flex-wrap gap-2 mt-2">
          <button
            type="button"
            onclick="addCustomColor()"
            class="bg-gray-300 w-10 h-10 rounded flex items-center justify-center"
          >
            +
          </button>
        </div>
      </div>

      <button
        onclick="processImage()"
        class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition duration-300"
      >
        Convert to Pixel Art
      </button>
    </div>

    <div class="max-w-md mx-auto mt-6 bg-white rounded-xl shadow-lg p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-2">Output:</h2>
      <div id="outputPlaceholder" class="text-gray-500 text-center">
        <p>Your pixel art will appear here.</p>
      </div>
      <img
        id="outputImage"
        class="w-full border rounded-md mb-4"
        style="display: none"
        alt="Processed pixel art output"
      />
      <div id="outputButtons" style="display: none" class="flex space-x-4">
        <a
          id="openImageLink"
          href="#"
          class="bg-gray-700 text-white py-2 px-4 rounded-md text-center"
          onclick="openImageInNewTab()"
          >Open in New Tab</a
        >
        <a
          id="downloadImageLink"
          href="#"
          download="pixel8_art.png"
          class="bg-green-600 text-white py-2 px-4 rounded-md text-center"
          >Download Image</a
        >
      </div>
    </div>

    <footer class="mt-8 text-center text-gray-400">
      <p>
        WASM Required -
        <a
          href="https://www.github.com/JamesMoreau"
          class="text-blue-500 hover:underline"
          >Github</a
        >
      </p>
    </footer>

    <script src="wasm_exec.js"></script>
    <script>
      // Initialize WASM
      const goWasm = new Go();
      let wasmInstance;

      WebAssembly.instantiateStreaming(
        fetch("main.wasm"),
        goWasm.importObject
      ).then((result) => {
        wasmInstance = result.instance;
        goWasm.run(wasmInstance);
      });

      const palettes = {
        vibrant: ["#E63946", "#F1FA3C", "#A8DADC", "#457B9D", "#1D3557"],
        pastel: ["#FFD1DC", "#AFCBFF", "#C3E8BD", "#FFABAB", "#FFC3A0"],
        grayscale: [
          "#000000",
          "#333333",
          "#666666",
          "#999999",
          "#CCCCCC",
          "#FFFFFF",
        ],
        nes: [
          "#808080",
          "#0000FF",
          "#00FF00",
          "#FF0000",
          "#FFFF00",
          "#FFA500",
          "#000000",
          "#FFFFFF",
        ],
        custom: [],
      };

      async function processImage() {
        const fileInput = document.getElementById("imageInput");
        const blockSize = parseInt(document.getElementById("blockSize").value);
        const paletteSelection = document.getElementById("palette").value;
        const palette =
          paletteSelection === "none" ? [] : palettes[paletteSelection] || [];

        if (fileInput.files.length === 0) {
          alert("Please upload an image!");
          return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = async function () {
          const imageData = reader.result;

          const rgbaPalette = palette.map(hexToRGBA);

          // Call the WASM function with the image data, block size, and palette.
          const resultImageData = await window.processPixel8(
            imageData,
            blockSize,
            rgbaPalette
          );

          const outputImage = document.getElementById("outputImage");
          const outputPlaceholder =
            document.getElementById("outputPlaceholder");
          const outputButtons = document.getElementById("outputButtons");

          // Hide the placeholder and show the processed image.
          outputPlaceholder.style.display = "none";
          outputImage.style.display = "block";
          outputImage.src = resultImageData;

          const openImageLink = document.getElementById("openImageLink");
          openImageLink.href = resultImageData;

          const downloadImageLink =
            document.getElementById("downloadImageLink");
          downloadImageLink.href = resultImageData;

          // Show the output buttons.
          outputButtons.style.display = "flex";
        };
        reader.readAsDataURL(file);
      }

      function openImageInNewTab() {
        const outputImage = document.getElementById("outputImage");

        if (outputImage && outputImage.src) {
          // Open the image in a new tab.
          const newWindow = window.open();
          if (newWindow) {
            // Write the image directly to the new window's document.
            newWindow.document.write(`<img src="${outputImage.src}"/>`);
            newWindow.document.title = "Pixel Art - Fullscreen";
          }
        } else {
          alert("No image available to open.");
        }
      }

      function hexToRGBA(hex) {
        const bigint = parseInt(hex.slice(1), 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return [r, g, b, 255];
      }

      function updatePaletteColors() {
        const palette = document.getElementById("palette").value;
        const colorDisplay = document.getElementById("colorDisplay");
        const customPaletteContainer = document.getElementById(
          "customPaletteContainer"
        );

        if (palette === "custom") {
          customPaletteContainer.style.display = "block";
        } else {
          customPaletteContainer.style.display = "none";
        }

        const colors = palettes[palette] || [];

        colorDisplay.innerHTML = "";

        colors.forEach((color) => {
          const colorSwatch = document.createElement("div");
          colorSwatch.style.backgroundColor = color;
          colorSwatch.className = "w-6 h-6 rounded-full border border-gray-300";
          colorDisplay.appendChild(colorSwatch);
        });
      }

      function addCustomColor() {
        const customPaletteColors = document.getElementById(
          "customPaletteColors"
        );
        const colorInput = document.createElement("input");
        colorInput.type = "color";
        colorInput.className = "w-10 h-10";
        colorInput.onchange = updateCustomPalette;

        customPaletteColors.insertBefore(
          colorInput,
          customPaletteColors.querySelector("button")
        );

        updateCustomPalette();
      }

      function updateCustomPalette() {
        const customPaletteColors = document.querySelectorAll(
          "#customPaletteColors input[type='color']"
        );
        palettes.custom = Array.from(customPaletteColors).map(
          (input) => input.value
        );
        updatePaletteColors();
      }

      updatePaletteColors();
    </script>
  </body>
</html>
